name: Build and deploy Aseprite

on:
  push:
    branches: [ master ]

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      # ---------- Ninja ----------
      - name: Install Ninja
        shell: bash
        run: |
          curl -L -o ninja.zip https://github.com/ninja-build/ninja/releases/download/v1.11.1/ninja-win.zip
          unzip ninja.zip -d ninja
          echo "${GITHUB_WORKSPACE}/ninja" >> $GITHUB_PATH
          ninja --version

      # ---------- Skia ----------
      - name: Get Skia from cache
        uses: actions/cache@v4
        with:
          path: skia
          key: skia-windows

      - name: Download Skia if not cached
        shell: bash
        run: |
          curl -L -o skia.zip https://github.com/aseprite/skia/releases/download/m81-b607b32047/Skia-Windows-Release-X64.zip
          unzip skia.zip -d skia

      # ---------- Aseprite ----------
      - name: Download Aseprite source
        shell: bash
        run: |
          curl -L -o aseprite.zip https://github.com/aseprite/aseprite/releases/latest/download/Aseprite-v1.3-Source.zip
          unzip aseprite.zip -d aseprite
          mkdir aseprite/build

      # ---------- Build (MSVC) ----------
      - name: Configure & Build (MSVC + Ninja)
        shell: cmd
        working-directory: aseprite/build
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=x64
          cmake -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DLAF_BACKEND=skia ^
            -DSKIA_DIR=../../skia ^
            -DSKIA_LIBRARY_DIR=../../skia/out/Release-x64 ..
          ninja aseprite

      # ---------- Package ----------
      - name: Package
        shell: bash
        working-directory: aseprite/build/bin
        run: |
          echo "# portable" > aseprite.ini
          7z a Aseprite-Windows.zip *
